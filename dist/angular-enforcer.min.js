#!/usr/bin/env node
"use strict";var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}}}();function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var _path=require("path");var _path2=_interopRequireDefault(_path);var _lodash=require("lodash");var _lodash2=_interopRequireDefault(_lodash);var _yargs=require("yargs");var _htmlparser2=require("htmlparser2");var _wordwrap=require("wordwrap");var _wordwrap2=_interopRequireDefault(_wordwrap);var _glob=require("glob");var _glob2=_interopRequireDefault(_glob);var _fs=require("fs");var _fs2=_interopRequireDefault(_fs);require("string.prototype.repeat");var basePath=_yargs.argv._.toString();var options={tab_length:4,line_max:100,selfClosingTags:false};var selfClosingTags=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];function process_glob(glob_string,basePath,func){(0,_glob2["default"])(glob_string,{cwd:basePath},function(err,files){if(err){console.error("Could not open files")}else{files.forEach(function(file){var filePath=_path2["default"].resolve(basePath,file);var fileDir=_path2["default"].dirname(filePath);var relativeDir="/"+_path2["default"].relative(basePath,fileDir);_fs2["default"].readFile(filePath,function(err,data){function updateFunc(newData){_fs2["default"].writeFile(filePath,newData,function(err){if(err){throw err}console.log("	File updated!")})}return func(err,data.toString(),filePath,updateFunc)})})}})}function formatValue(value,indent){if(value[0]==="{"&&_lodash2["default"].last(value)==="}"){var spaces=" ".repeat(indent);return value.replace(/\,\s\'/g,",\n"+spaces+"'")}return value}function isSelfClosing(node){return _lodash2["default"].includes(selfClosingTags,node.name)}function getRaw(node){var text="";text+=node.name;_lodash2["default"].each(node.attribs,function(value,key){text+=" "+key+'="'+value+'"'});return text}function canEndSameLine(node,text,spaces,raw){if(!node.name||isSelfClosing(node)||node.type==="text"||spaces.length+raw.length>options.line_max){return false}var additional_chars=_lodash2["default"].last(text.split("\n")).length+node.name.length+3;return node.children.length===0&&additional_chars<=options.line_max}function formateNodeHeader(node,spaces,level){var text="";var rawNode=getRaw(node);if(node.name){if(spaces.length+rawNode.length+3<=options.line_max){if(isSelfClosing(node)&&options.selfClosingTags){text=spaces+"<"+rawNode+" />\n"}else{text=spaces+"<"+rawNode+">\n"}}else{(function(){var attrs=_lodash2["default"].pairs(node.attribs);text=spaces+"<"+node.name+" ";attrs.forEach(function(_ref,index){var _ref2=_slicedToArray(_ref,2);var attrName=_ref2[0];var attrValue=_ref2[1];if(index>0){text+=spaces+" ".repeat(options.tab_length)}text+=attrName+'="';var indent=_lodash2["default"].last(text.split("\n")).length+1;text+=formatValue(attrValue,indent)+'"';if(index===attrs.length-1){text+=">\n"}else{text+="\n"}})})()}}if(canEndSameLine(node,text,spaces,rawNode)){text=text.substring(0,text.length-1)}return text}function breakLongLines(line){if(line.length>options.line_max){var _ret2=function(){console.log("long");var words=line.split(" ");var spaceLeft=options.line_max;words.forEach(function(word){if(word.length>spaceLeft){word="\n"+word;spaceLeft=options.line_max-word.length}else{spaceLeft-=word.length}});return{v:words.join(" ")}}();if(typeof _ret2==="object")return _ret2.v}return line}function parseNode(node){var level=arguments.length<=1||arguments[1]===undefined?0:arguments[1];var text="";var spaces=spaces=" ".repeat(options.tab_length).repeat(level);text+=formateNodeHeader(node,spaces,level);var sameLineEnding=text[text.length-1]!=="\n";if(node.children){node.children.forEach(function(child){text+=parseNode(child,level+1)})}if(node.type==="text"){var wrapLine=(0,_wordwrap2["default"])(spaces.length,options.line_max);text+=spaces+decodeURI(wrapLine(node.data)).trim()+"\n"}if(node.name&&!isSelfClosing(node)){if(sameLineEnding){text+="</"+node.name+">\n"}else{text+=spaces+"</"+node.name+">\n"}}return text}process_glob("**/*.html",basePath,function(err,data,file,update){console.log("\n",file);data=data.replace(/\>[\s]+\</gi,"><").replace(/\n\s+/gi," ");var handler=new _htmlparser2.DefaultHandler(function(error,dom){if(error)console.error(error);else{var final_text="";dom.forEach(function(node){final_text+=parseNode(node)});console.log(final_text);update(final_text)}},{ignoreWhitespace:true});var parser=new _htmlparser2.Parser(handler);parser.parseComplete(data)});
